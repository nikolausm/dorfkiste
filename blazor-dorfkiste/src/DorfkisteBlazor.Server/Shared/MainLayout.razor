@inherits LayoutComponentBase
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@implements IAsyncDisposable

<MudThemeProvider Theme="@_theme" />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="0" Class="ebay-header" Color="Color.Surface" Style="border-bottom: 1px solid #e5e5e5; height: 64px;">
        <!-- Top row with logo, search, and user actions -->
        <div class="d-flex align-center w-100" style="height: 100%;">
            <!-- Mobile Menu Button -->
            <MudIconButton Icon="@Icons.Material.Filled.Menu" 
                           Color="Color.Inherit" 
                           Edge="Edge.Start" 
                           OnClick="@DrawerToggle"
                           Class="d-lg-none mr-2" />
            
            <!-- eBay Logo -->
            <MudButton Href="/" 
                       Variant="Variant.Text" 
                       Color="Color.Primary"
                       Class="ebay-logo-button mr-4"
                       Style="min-width: auto; padding: 8px 16px;">
                <MudText Typo="Typo.h5" Style="font-weight: bold; color: #0064d2;">
                    <span style="color: #e62048;">e</span><span style="color: #0064d2;">B</span><span style="color: #f5af02;">a</span><span style="color: #0064d2;">y</span>
                </MudText>
            </MudButton>
            
            <!-- Categories Dropdown - Desktop only -->
            <MudHidden Breakpoint="Breakpoint.MdAndDown" Invert="true">
                <MudMenu Icon="@Icons.Material.Filled.Apps" 
                         Color="Color.Inherit"
                         Class="mr-3 category-menu"
                         Dense="true">
                    <MudMenuItem Href="/categories">Alle Kategorien</MudMenuItem>
                    <MudMenuItem Href="/items?category=werkzeuge">Werkzeuge</MudMenuItem>
                    <MudMenuItem Href="/items?category=garten">Garten</MudMenuItem>
                    <MudMenuItem Href="/items?category=elektronik">Elektronik</MudMenuItem>
                    <MudMenuItem Href="/items?category=sport">Sport</MudMenuItem>
                    <MudMenuItem Href="/items?category=haushalt">Haushalt</MudMenuItem>
                </MudMenu>
            </MudHidden>
            
            <!-- Search Bar - Central -->
            <div class="flex-grow-1 mx-3" style="max-width: 500px;">
                <div class="ebay-search-container">
                    <SearchBar />
                </div>
            </div>
            
            <!-- Desktop Navigation Links -->
            <MudHidden Breakpoint="Breakpoint.MdAndDown" Invert="true">
                <div class="d-flex align-center mr-3">
                    <MudButton Href="/items" 
                               Variant="Variant.Text" 
                               Color="Color.Inherit"
                               Class="nav-link-button mx-1"
                               Style="font-size: 13px;">
                        Entdecken
                    </MudButton>
                    <MudButton Href="/help" 
                               Variant="Variant.Text" 
                               Color="Color.Inherit"
                               Class="nav-link-button mx-1"
                               Style="font-size: 13px;">
                        Hilfe & Kontakt
                    </MudButton>
                </div>
            </MudHidden>
        
        <!-- User Actions -->
            <div class="d-flex align-center">
                <AuthorizeView Context="authContext">
                    <Authorized Context="authUser">
                        <!-- Notifications with eBay styling -->
                        <MudIconButton Icon="@Icons.Material.Filled.Notifications"
                                       Color="Color.Inherit"
                                       Href="/notifications"
                                       Class="ebay-icon-button mr-1"
                                       Style="border-radius: 4px;">
                            <MudBadge Content="@_unreadCount" 
                                      Color="Color.Error" 
                                      Visible="@(_unreadCount > 0)"
                                      Max="9">
                                <MudIcon Icon="@Icons.Material.Filled.Notifications" />
                            </MudBadge>
                        </MudIconButton>
                        
                        <!-- Watchlist -->
                        <MudIconButton Icon="@Icons.Material.Filled.Favorite"
                                       Color="Color.Inherit"
                                       Href="/watchlist"
                                       Class="ebay-icon-button mr-1"
                                       Style="border-radius: 4px;" />
                        
                        <!-- Add Item Button - eBay Style -->
                        <MudButton Href="/items/new"
                                   Variant="Variant.Outlined"
                                   Color="Color.Primary"
                                   Class="ebay-sell-button mr-3"
                                   Style="border: 1px solid #0064d2; color: #0064d2; font-weight: 600; text-transform: none; border-radius: 20px; font-size: 13px;">
                            <MudHidden Breakpoint="Breakpoint.SmAndDown" Invert="true">
                                Verkaufen
                            </MudHidden>
                            <MudHidden Breakpoint="Breakpoint.SmAndDown">
                                <MudIcon Icon="@Icons.Material.Filled.Add" />
                            </MudHidden>
                        </MudButton>
                        
                        <!-- User Menu -->
                        <MudMenu Icon="@Icons.Material.Filled.AccountCircle" 
                                 Color="Color.Inherit"
                                 AnchorOrigin="Origin.BottomRight"
                                 TransformOrigin="Origin.TopRight"
                                 Class="ebay-user-menu">
                            <div class="pa-4" style="min-width: 200px;">
                                <MudText Typo="Typo.subtitle1">@authUser.User.Identity?.Name</MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">@GetUserEmail()</MudText>
                            </div>
                            <MudDivider />
                            <MudMenuItem Icon="@Icons.Material.Filled.Person" Href="/profile">
                                Mein Profil
                            </MudMenuItem>
                            <MudMenuItem Icon="@Icons.Material.Filled.Assignment" Href="/my-rentals">
                                Meine Buchungen
                            </MudMenuItem>
                            <MudMenuItem Icon="@Icons.Material.Filled.Inventory" Href="/my-items">
                                Meine Artikel
                            </MudMenuItem>
                            <MudMenuItem Icon="@Icons.Material.Filled.Favorite" Href="/watchlist">
                                Watchlist
                            </MudMenuItem>
                            <MudDivider />
                            <AuthorizeView Roles="Admin" Context="adminMenuContext">
                                <MudMenuItem Icon="@Icons.Material.Filled.AdminPanelSettings" Href="/admin">
                                    Administration
                                </MudMenuItem>
                                <MudDivider />
                            </AuthorizeView>
                            <MudMenuItem Icon="@Icons.Material.Filled.Logout" OnClick="@Logout">
                                Abmelden
                            </MudMenuItem>
                        </MudMenu>
                    </Authorized>
                    <NotAuthorized>
                        <MudButton Href="/auth/signin"
                                   Variant="Variant.Text"
                                   Color="Color.Inherit"
                                   Class="ebay-text-button mr-2"
                                   Style="font-size: 13px; text-transform: none;">
                            Anmelden
                        </MudButton>
                        <MudButton Href="/auth/signup"
                                   Variant="Variant.Outlined"
                                   Color="Color.Primary"
                                   Class="ebay-register-button"
                                   Style="border: 1px solid #0064d2; color: #0064d2; font-weight: 600; text-transform: none; border-radius: 20px; font-size: 13px;">
                            Registrieren
                        </MudButton>
                    </NotAuthorized>
                </AuthorizeView>
            </div>
        </div>
    </MudAppBar>
    
    <!-- Mobile/Tablet Drawer -->
    <MudDrawer @bind-Open="_drawerOpen" 
               ClipMode="DrawerClipMode.Never" 
               Elevation="2"
               Breakpoint="Breakpoint.Lg">
        <MudDrawerHeader>
            <MudText Typo="Typo.h6" Color="Color.Success">
                <strong>Dorfkiste</strong>
            </MudText>
        </MudDrawerHeader>
        <MudNavMenu Class="mud-width-full">
            <!-- Search Bar - Mobile -->
            <MudHidden Breakpoint="Breakpoint.LgAndUp" Invert="true">
                <MudNavGroup Title="Suche" Icon="@Icons.Material.Filled.Search" Class="mb-2">
                    <div class="pa-4">
                        <SearchBar />
                    </div>
                </MudNavGroup>
                <MudDivider Class="mb-2" />
            </MudHidden>
            
            <MudNavLink Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home">
                Startseite
            </MudNavLink>
            <MudNavLink Href="/items" Icon="@Icons.Material.Filled.Inventory">
                Alle Artikel
            </MudNavLink>
            <MudNavLink Href="/categories" Icon="@Icons.Material.Filled.Category">
                Kategorien
            </MudNavLink>
            
            <AuthorizeView Context="mobileAuthContext">
                <Authorized Context="mobileAuth">
                    <MudDivider Class="my-2" />
                    <MudNavGroup Title="Mein Bereich" Icon="@Icons.Material.Filled.Person" Expanded="false">
                        <MudNavLink Href="/items/new" Icon="@Icons.Material.Filled.Add">
                            Artikel einstellen
                        </MudNavLink>
                        <MudNavLink Href="/my-items" Icon="@Icons.Material.Filled.Inventory">
                            Meine Artikel
                        </MudNavLink>
                        <MudNavLink Href="/my-rentals" Icon="@Icons.Material.Filled.Assignment">
                            Meine Buchungen
                        </MudNavLink>
                        <MudNavLink Href="/profile" Icon="@Icons.Material.Filled.Person">
                            Profil
                        </MudNavLink>
                        <MudNavLink Href="/notifications" Icon="@Icons.Material.Filled.Notifications">
                            Benachrichtigungen
                            @if (_unreadCount > 0)
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Error" Class="ml-auto">
                                    @_unreadCount
                                </MudChip>
                            }
                        </MudNavLink>
                        <MudNavLink Href="/watchlist" Icon="@Icons.Material.Filled.Favorite">
                            Watchlist
                        </MudNavLink>
                    </MudNavGroup>
                    
                    <AuthorizeView Roles="Admin" Context="mobileAdminContext">
                        <MudDivider Class="my-2" />
                        <MudNavGroup Title="Administration" Icon="@Icons.Material.Filled.AdminPanelSettings" Expanded="false">
                            <MudNavLink Href="/admin/dashboard" Icon="@Icons.Material.Filled.Dashboard">
                                Dashboard
                            </MudNavLink>
                            <MudNavLink Href="/admin/users" Icon="@Icons.Material.Filled.People">
                                Benutzer
                            </MudNavLink>
                            <MudNavLink Href="/admin/items" Icon="@Icons.Material.Filled.Inventory">
                                Artikel
                            </MudNavLink>
                            <MudNavLink Href="/admin/rentals" Icon="@Icons.Material.Filled.Receipt">
                                Buchungen
                            </MudNavLink>
                            <MudNavLink Href="/admin/reports" Icon="@Icons.Material.Filled.Analytics">
                                Berichte
                            </MudNavLink>
                        </MudNavGroup>
                    </AuthorizeView>
                </Authorized>
            </AuthorizeView>
            
            <MudDivider Class="my-2" />
            <MudNavLink Href="/help" Icon="@Icons.Material.Filled.Help">
                Hilfe
            </MudNavLink>
            <MudNavLink Href="/contact" Icon="@Icons.Material.Filled.ContactMail">
                Kontakt
            </MudNavLink>
            <MudNavLink Href="/about" Icon="@Icons.Material.Filled.Info">
                Über uns
            </MudNavLink>
        </MudNavMenu>
    </MudDrawer>
    
    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pa-4">
            <MudBreadcrumbs Items="_breadcrumbItems" Class="mb-4" />
            
            <!-- Loading State -->
            @if (_isLoading)
            {
                <div class="d-flex justify-center align-center" style="min-height: 200px;">
                    <MudProgressCircular Color="Color.Success" Indeterminate="true" Size="Size.Large" />
                </div>
            }
            else
            {
                <CascadingValue Value="this">
                    <Microsoft.AspNetCore.Components.Web.ErrorBoundary>
                        @Body
                    </Microsoft.AspNetCore.Components.Web.ErrorBoundary>
                </CascadingValue>
            }
        </MudContainer>
        
        <!-- Footer -->
        <MainFooter />
    </MudMainContent>
</MudLayout>

<!-- SignalR Connection Status -->

@code {
    private bool _drawerOpen = false;
    private bool _isLoading = true;
    private int _unreadCount = 0;
    private Timer? _unreadCountTimer;
    private List<BreadcrumbItem> _breadcrumbItems = new();
    
    private readonly MudTheme _theme = new()
    {
        PaletteLight = new PaletteLight()
        {
            Primary = "#0064d2", // eBay Blue
            Secondary = "#f5af02", // eBay Yellow
            Success = "#1ba345", // eBay Green
            Info = "#0064d2",
            Warning = "#f5af02",
            Error = "#e62048", // eBay Red
            Dark = "#1f1f1f",
            Surface = "#ffffff",
            Background = "#f7f7f7", // eBay light gray background
            AppbarBackground = "#ffffff",
            DrawerBackground = "#ffffff"
        },
        PaletteDark = new PaletteDark()
        {
            Primary = "#0084ff",
            Secondary = "#f5af02",
            Success = "#1ba345",
            Info = "#0084ff",
            Warning = "#f5af02",
            Error = "#e62048",
            Dark = "#1f1f1f",
            Surface = "#2a2a2a",
            Background = "#1f1f1f",
            AppbarBackground = "#2a2a2a",
            DrawerBackground = "#2a2a2a"
        }
    };

    protected override async Task OnInitializedAsync()
    {
        // Set up breadcrumbs based on current URL
        UpdateBreadcrumbs();
        
        // Start unread count timer
        _unreadCountTimer = new Timer(UpdateUnreadCount, null, TimeSpan.Zero, TimeSpan.FromSeconds(30));
        
        // Simulate initial loading
        await Task.Delay(500);
        _isLoading = false;
        StateHasChanged();
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Store component initialization in memory
                await JSRuntime.InvokeVoidAsync("console.log", "UI-Dev: MainLayout initialized with responsive design and authentication");
            }
            catch (Exception ex)
            {
                // Log exception but don't throw - this is for debugging only
                Console.WriteLine($"JS Interop failed: {ex.Message}");
            }
        }
    }

    private void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    private string GetUserEmail()
    {
        // This would typically come from authentication context
        return "user@example.com";
    }

    private async Task Logout()
    {
        // Logout logic would go here
        Navigation.NavigateTo("/auth/signin");
        Snackbar.Add("Erfolgreich abgemeldet", Severity.Success);
    }

    private void UpdateBreadcrumbs()
    {
        _breadcrumbItems.Clear();
        
        var uri = Navigation.ToBaseRelativePath(Navigation.Uri);
        var segments = uri.Split('/', StringSplitOptions.RemoveEmptyEntries);
        
        _breadcrumbItems.Add(new BreadcrumbItem("Startseite", "/", false, Icons.Material.Filled.Home));
        
        var currentPath = "";
        foreach (var segment in segments)
        {
            currentPath += "/" + segment;
            var displayName = GetDisplayName(segment);
            var isLast = segment == segments.LastOrDefault();
            
            _breadcrumbItems.Add(new BreadcrumbItem(displayName, currentPath, !isLast));
        }
    }

    private string GetDisplayName(string segment)
    {
        return segment switch
        {
            "items" => "Artikel",
            "categories" => "Kategorien",
            "profile" => "Profil",
            "my-items" => "Meine Artikel",
            "my-rentals" => "Meine Buchungen",
            "notifications" => "Benachrichtigungen",
            "admin" => "Administration",
            "help" => "Hilfe",
            "contact" => "Kontakt",
            "about" => "Über uns",
            "auth" => "Anmeldung",
            "signin" => "Anmelden",
            "signup" => "Registrieren",
            "new" => "Neu",
            _ => segment.Replace("-", " ").ToTitleCase()
        };
    }

    private async void UpdateUnreadCount(object? state)
    {
        try
        {
            // This would typically call an API to get unread count
            // For now, simulate with random number
            var random = new Random();
            var newCount = random.Next(0, 5);
            
            if (newCount != _unreadCount)
            {
                _unreadCount = newCount;
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            // Log error without JS interop
            Console.WriteLine($"Error updating unread count: {ex.Message}");
        }
    }

    public async ValueTask DisposeAsync()
    {
        _unreadCountTimer?.Dispose();
        // Log without JS interop
        Console.WriteLine("UI-Dev: MainLayout disposed");
        await Task.CompletedTask;
    }
}

<!-- Add custom styles -->
<style>
    .mud-layout {
        min-height: 100vh;
    }
    
    /* eBay Header Styles */
    .ebay-header {
        background-color: #ffffff !important;
        border-bottom: 1px solid #e5e5e5 !important;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1) !important;
    }
    
    .ebay-logo-button {
        min-width: auto !important;
        padding: 8px 16px !important;
    }
    
    .ebay-logo-button:hover {
        background-color: rgba(0, 100, 210, 0.04) !important;
    }
    
    .category-menu .mud-button {
        font-size: 13px;
        color: #666;
        text-transform: none;
    }
    
    .category-menu .mud-button:hover {
        color: #0064d2;
    }
    
    .ebay-search-container {
        position: relative;
    }
    
    .nav-link-button {
        color: #666 !important;
        text-transform: none !important;
        font-weight: 400 !important;
        padding: 8px 12px !important;
        border-radius: 4px !important;
    }
    
    .nav-link-button:hover {
        color: #0064d2 !important;
        background-color: rgba(0, 100, 210, 0.04) !important;
    }
    
    .ebay-icon-button {
        color: #666 !important;
        padding: 8px !important;
    }
    
    .ebay-icon-button:hover {
        color: #0064d2 !important;
        background-color: rgba(0, 100, 210, 0.04) !important;
    }
    
    .ebay-sell-button {
        padding: 8px 20px !important;
        height: 32px !important;
        min-height: 32px !important;
    }
    
    .ebay-sell-button:hover {
        background-color: rgba(0, 100, 210, 0.04) !important;
    }
    
    .ebay-text-button {
        color: #666 !important;
        font-weight: 400 !important;
    }
    
    .ebay-text-button:hover {
        color: #0064d2 !important;
    }
    
    .ebay-register-button {
        padding: 8px 20px !important;
        height: 32px !important;
        min-height: 32px !important;
    }
    
    .ebay-register-button:hover {
        background-color: rgba(0, 100, 210, 0.04) !important;
    }
    
    .mud-drawer {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    @@media (max-width: 960px) {
        .mud-container {
            padding-left: 8px !important;
            padding-right: 8px !important;
        }
        
        .ebay-header {
            height: 56px !important;
        }
        
        .ebay-logo-button {
            padding: 4px 12px !important;
        }
        
        .ebay-sell-button,
        .ebay-register-button {
            min-width: auto !important;
            padding: 6px 12px !important;
            height: 28px !important;
            min-height: 28px !important;
            font-size: 12px !important;
        }
    }
    
    .mud-nav-link:hover {
        background-color: rgba(0, 100, 210, 0.08) !important;
        color: #0064d2 !important;
    }
    
    .mud-nav-link.active {
        background-color: rgba(0, 100, 210, 0.12) !important;
        color: #0064d2 !important;
        font-weight: 600;
    }
    
    /* eBay Color adjustments for content */
    .mud-main-content {
        background-color: #f7f7f7;
    }
</style>