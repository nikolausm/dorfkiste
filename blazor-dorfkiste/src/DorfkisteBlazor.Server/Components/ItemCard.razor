@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject ISnackbar Snackbar

<MudCard Class="ebay-item-card" Elevation="0">
    <!-- Image Section -->
    <div class="item-image-container" @onclick="@(() => NavigateToItem())">
        @if (!string.IsNullOrEmpty(ImageUrl))
        {
            <MudCardMedia Image="@ImageUrl" Alt="@Title" Height="200" />
        }
        else
        {
            <div class="item-image-placeholder">
                <MudIcon Icon="@Icons.Material.Filled.Image" Size="Size.Large" Color="Color.Secondary" />
            </div>
        }
        
        <!-- Availability Badge - eBay Style -->
        <MudChip T="string" Class="ebay-availability-badge" 
                 Size="Size.Small" 
                 Color="@(Available ? Color.Success : Color.Error)"
                 Text="@(Available ? "Verf端gbar" : "Belegt")" />
        
        <!-- Condition Badge - eBay Style -->
        @if (!string.IsNullOrEmpty(Condition))
        {
            <MudChip T="string" Class="ebay-condition-badge" 
                     Size="Size.Small" 
                     Color="@GetConditionColor()"
                     Text="@Condition" />
        }
        
        <!-- Favorite Button -->
        <MudIconButton Icon="@(IsFavorite ? Icons.Material.Filled.Favorite : Icons.Material.Filled.FavoriteBorder)"
                       Color="@(IsFavorite ? Color.Error : Color.Default)"
                       Class="favorite-button"
                       OnClick="@ToggleFavorite"
                       OnClick:stopPropagation="true" />
    </div>
    
    <!-- Content Section -->
    <MudCardContent Class="pa-3">
        <!-- Title -->
        <MudText Typo="Typo.h6" 
                 Class="item-title cursor-pointer" 
                 @onclick="@(() => NavigateToItem())">
            @Title
        </MudText>
        
        <!-- Location and View Count -->
        <div class="d-flex align-center justify-space-between mb-2">
            <div class="d-flex align-center">
                <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Color="Color.Secondary" />
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="ml-1">
                    @Location
                </MudText>
            </div>
            <MudText Typo="Typo.caption" Color="Color.Secondary">
                <MudIcon Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" Class="mr-1" />
                @ViewCount Aufrufe
            </MudText>
        </div>
        
        <!-- Price - eBay Style -->
        <div class="ebay-price-section mb-2">
            @if (PricePerDay.HasValue)
            {
                <MudText Typo="Typo.h6" Class="ebay-price-main">
                    @PricePerDay.Value.ToString("C")<span class="ebay-price-unit">/Tag</span>
                </MudText>
                @if (PricePerHour.HasValue)
                {
                    <MudText Typo="Typo.caption" Class="ebay-price-alternative">
                        oder @PricePerHour.Value.ToString("C")/Stunde
                    </MudText>
                }
            }
            else
            {
                <MudText Typo="Typo.body2" Class="ebay-price-request">
                    Preis auf Anfrage
                </MudText>
            }
        </div>
        
        <!-- User Info -->
        @if (User != null)
        {
            <div class="d-flex align-center justify-space-between">
                <div class="d-flex align-center">
                    <MudAvatar Size="Size.Small" Class="mr-2">
                        @if (!string.IsNullOrEmpty(User.AvatarUrl))
                        {
                            <MudImage Src="@User.AvatarUrl" Alt="@User.Name" />
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Person" />
                        }
                    </MudAvatar>
                    <div>
                        <MudText Typo="Typo.caption" Class="font-weight-medium">
                            @User.Name
                        </MudText>
                        <div class="d-flex align-center">
                            <MudRating ReadOnly="true" SelectedValue="@((int)User.Rating)" Size="Size.Small" />
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="ml-1">
                                (@User.ReviewCount)
                            </MudText>
                        </div>
                    </div>
                </div>
            </div>
        }
    </MudCardContent>
    
    <!-- Action Buttons - eBay Style -->
    <MudCardActions Class="ebay-actions pa-3 pt-0">
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Primary" 
                   FullWidth="true"
                   StartIcon="@Icons.Material.Filled.Event"
                   OnClick="@(() => ShowRentalDialog())"
                   Disabled="@(!Available)"
                   Class="ebay-booking-button">
            @(Available ? "Jetzt buchen" : "Nicht verf端gbar")
        </MudButton>
        
        <MudMenu Icon="@Icons.Material.Filled.MoreVert" 
                 Color="Color.Default" 
                 Dense="true"
                 AnchorOrigin="Origin.BottomRight"
                 TransformOrigin="Origin.TopRight"
                 Class="ebay-menu">
            <MudMenuItem Icon="@Icons.Material.Filled.Share" OnClick="@ShareItem">
                Teilen
            </MudMenuItem>
            <MudMenuItem Icon="@Icons.Material.Filled.Report" OnClick="@ReportItem">
                Melden
            </MudMenuItem>
        </MudMenu>
    </MudCardActions>
</MudCard>

@code {
    [Parameter] public int Id { get; set; }
    [Parameter] public string Title { get; set; } = string.Empty;
    [Parameter] public string? ImageUrl { get; set; }
    [Parameter] public decimal? PricePerDay { get; set; }
    [Parameter] public decimal? PricePerHour { get; set; }
    [Parameter] public string Location { get; set; } = string.Empty;
    [Parameter] public string? Condition { get; set; }
    [Parameter] public bool Available { get; set; } = true;
    [Parameter] public UserInfo? User { get; set; }
    [Parameter] public int ViewCount { get; set; }
    [Parameter] public bool IsFavorite { get; set; }
    [Parameter] public EventCallback<int> OnFavoriteToggle { get; set; }
    [Parameter] public EventCallback<int> OnRentalRequest { get; set; }
    
    // Alternative parameter to accept an ItemModel
    [Parameter] public ItemModel? Item { get; set; }

    protected override async Task OnInitializedAsync()
    {
        // If an ItemModel is provided, populate individual parameters
        if (Item != null)
        {
            Id = Item.Id;
            Title = Item.Title;
            ImageUrl = Item.ImageUrl;
            PricePerDay = Item.PricePerDay;
            PricePerHour = Item.PricePerHour;
            Location = Item.Location;
            Condition = Item.Condition;
            Available = Item.Available;
            User = Item.User;
            ViewCount = Item.ViewCount;
            IsFavorite = Item.IsFavorite;
        }
        
        await JSRuntime.InvokeVoidAsync("console.log", $"UI-Dev: Initializing ItemCard for item {Id}");
    }

    private void NavigateToItem()
    {
        Navigation.NavigateTo($"/items/{Id}");
    }

    private async Task ToggleFavorite()
    {
        IsFavorite = !IsFavorite;
        
        if (OnFavoriteToggle.HasDelegate)
        {
            await OnFavoriteToggle.InvokeAsync(Id);
        }
        
        var message = IsFavorite ? "Zur Watchlist hinzugef端gt" : "Aus Watchlist entfernt";
        Snackbar.Add(message, IsFavorite ? Severity.Success : Severity.Info);
        
        await JSRuntime.InvokeVoidAsync("console.log", $"UI-Dev: Favorite toggled for item {Id}: {IsFavorite}");
    }

    private async Task ShowRentalDialog()
    {
        if (OnRentalRequest.HasDelegate)
        {
            await OnRentalRequest.InvokeAsync(Id);
        }
        else
        {
            // Navigate to rental page as fallback
            Navigation.NavigateTo($"/rentals/new?itemId={Id}");
        }
        
        await JSRuntime.InvokeVoidAsync("console.log", $"UI-Dev: Rental dialog requested for item {Id}");
    }

    private async Task ShareItem()
    {
        try
        {
            var url = $"{Navigation.BaseUri}items/{Id}";
            await JSRuntime.InvokeVoidAsync("navigator.share", new
            {
                title = Title,
                text = $"Schau dir diesen Artikel auf Dorfkiste an: {Title}",
                url = url
            });
        }
        catch
        {
            // Fallback to clipboard
            var url = $"{Navigation.BaseUri}items/{Id}";
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", url);
            Snackbar.Add("Link in Zwischenablage kopiert", Severity.Success);
        }
        
        await JSRuntime.InvokeVoidAsync("console.log", $"UI-Dev: Item shared: {Id}");
    }

    private async Task ReportItem()
    {
        Snackbar.Add("Artikel wurde gemeldet. Vielen Dank f端r den Hinweis.", Severity.Info);
        await JSRuntime.InvokeVoidAsync("console.log", $"UI-Dev: Item reported: {Id}");
    }

    private Color GetConditionColor()
    {
        return Condition?.ToLower() switch
        {
            "neu" => Color.Success,
            "sehr gut" => Color.Info,
            "gut" => Color.Primary,
            "gebraucht" => Color.Warning,
            "defekt" => Color.Error,
            _ => Color.Default
        };
    }

    public class UserInfo
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string? AvatarUrl { get; set; }
        public double Rating { get; set; } = 4.5;
        public int ReviewCount { get; set; }
    }

    public class ItemModel
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public string? ImageUrl { get; set; }
        public decimal? PricePerDay { get; set; }
        public decimal? PricePerHour { get; set; }
        public string Location { get; set; } = string.Empty;
        public string? Condition { get; set; }
        public bool Available { get; set; } = true;
        public UserInfo? User { get; set; }
        public int ViewCount { get; set; }
        public bool IsFavorite { get; set; }
    }
}

<style>
    /* eBay-Style Item Card */
    .ebay-item-card {
        border: 1px solid #e5e5e5;
        border-radius: 8px;
        background: white;
        transition: all 0.2s ease;
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .ebay-item-card:hover {
        border-color: #0064d2;
        box-shadow: 0 2px 8px rgba(0, 100, 210, 0.1);
        transform: translateY(-1px);
    }
    
    .item-image-container {
        position: relative;
        cursor: pointer;
        overflow: hidden;
    }
    
    .item-image-container .mud-card-media {
        transition: transform 0.3s ease;
    }
    
    .ebay-item-card:hover .mud-card-media {
        transform: scale(1.02);
    }
    
    .item-image-placeholder {
        height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f8f9fa;
        border-bottom: 1px solid #e5e5e5;
    }
    
    /* eBay-Style Badges */
    .ebay-availability-badge {
        position: absolute;
        top: 8px;
        left: 8px;
        z-index: 2;
        border-radius: 4px;
        font-weight: 500;
        font-size: 0.75rem;
        padding: 4px 8px;
    }
    
    .ebay-condition-badge {
        position: absolute;
        top: 8px;
        right: 50px;
        z-index: 2;
        border-radius: 4px;
        font-weight: 500;
        font-size: 0.75rem;
        padding: 4px 8px;
    }
    
    .favorite-button {
        position: absolute;
        top: 8px;
        right: 8px;
        z-index: 3;
        background-color: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(4px);
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        transition: all 0.2s ease;
        width: 36px;
        height: 36px;
    }
    
    .favorite-button:hover {
        background-color: rgba(255, 255, 255, 1);
        transform: scale(1.05);
        border-color: #0064d2;
    }
    
    .item-title {
        font-weight: 600;
        line-height: 1.3;
        margin-bottom: 8px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        transition: color 0.2s ease;
        color: #1f2937;
    }
    
    .item-title:hover {
        color: #0064d2;
    }
    
    /* eBay-Style Price Section */
    .ebay-price-section {
        padding: 8px 0;
        margin: 8px 0;
    }
    
    .ebay-price-main {
        font-weight: 700;
        margin-bottom: 2px;
        color: #1f2937;
        font-size: 1.125rem;
    }
    
    .ebay-price-unit {
        font-size: 0.8em;
        font-weight: 400;
        color: #6b7280;
        margin-left: 2px;
    }
    
    .ebay-price-alternative {
        color: #6b7280;
        font-size: 0.875rem;
    }
    
    .ebay-price-request {
        color: #0064d2;
        font-weight: 600;
    }
    
    .mud-card-content {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        padding: 16px;
    }
    
    /* eBay-Style Actions */
    .ebay-actions {
        border-top: 1px solid #e5e5e5;
        background-color: #f8f9fa;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .ebay-booking-button {
        background-color: #0064d2 !important;
        border: none !important;
        border-radius: 18px !important;
        font-weight: 600 !important;
        text-transform: none !important;
        transition: all 0.2s ease !important;
        flex-grow: 1;
    }
    
    .ebay-booking-button:hover {
        background-color: #004c9c !important;
        transform: translateY(-1px);
    }
    
    .ebay-booking-button:disabled {
        background-color: #9ca3af !important;
        cursor: not-allowed;
        transform: none;
    }
    
    .ebay-menu {
        border: 1px solid #e5e5e5 !important;
        border-radius: 50% !important;
        background-color: white !important;
        transition: all 0.2s ease !important;
    }
    
    .ebay-menu:hover {
        border-color: #0064d2 !important;
        background-color: #f8f9fa !important;
    }
    
    /* Responsive Design */
    @@media (max-width: 960px) {
        .ebay-item-card {
            margin-bottom: 16px;
        }
        
        .ebay-condition-badge {
            right: 40px;
            font-size: 0.7rem;
            padding: 3px 6px;
        }
        
        .ebay-availability-badge {
            font-size: 0.7rem;
            padding: 3px 6px;
        }
        
        .favorite-button {
            width: 32px;
            height: 32px;
        }
    }
    
    @@media (max-width: 600px) {
        .mud-card-content {
            padding: 12px;
        }
        
        .ebay-price-main {
            font-size: 1rem;
        }
        
        .ebay-booking-button {
            font-size: 0.875rem;
            padding: 8px 16px !important;
        }
        
        .ebay-condition-badge {
            right: 35px;
            transform: scale(0.85);
        }
        
        .ebay-availability-badge {
            transform: scale(0.85);
        }
    }
</style>